# P0.1 Phase 3: Runtime Integration - COMPLETED ✅

## Completion Date
October 19, 2025

## Summary
Phase 3 integrated the condition evaluator into the workflow runtime engine, enabling workflows to actually branch based on runtime conditions. Steps are now automatically activated or skipped based on their conditional logic during workflow execution.

## Delivered Components

### 1. `determineNextSteps()` Function (`lib/workflows/runtime.ts`)
**Lines**: ~180  
**Purpose**: Intelligently determine and activate next workflow steps based on conditions

**Key Features**:
- Evaluates conditions on pending steps
- Activates steps with true conditions (IF_TRUE) or skips them
- Handles unconditional steps (ALWAYS)
- Continues evaluation after skipping steps (enables branching)
- Records metrics for activations and skips
- Sends notifications for newly ready steps
- Comprehensive error handling with logging

**Algorithm**:
1. Fetch all steps for the workflow instance (ordered)
2. Build evaluation context from instance.contextData
3. For each PENDING step:
   - If `conditionType === "ALWAYS"`: Activate if all prior steps are terminal
   - If `conditionType === "IF_TRUE"`: Evaluate condition, activate if true, skip if false
   - If `conditionType === "IF_FALSE"`: Evaluate condition, activate if false, skip if true
4. Return count of steps activated

**Signature**:
```typescript
export async function determineNextSteps({
  tx,
  instance,
  completedStep,
  now = new Date(),
}: {
  tx: PrismaClient | Prisma.TransactionClient;
  instance: WorkflowInstance;
  completedStep?: WorkflowInstanceStepWithTemplate;
  now?: Date;
}): Promise<number>
```

### 2. Updated API Endpoints

#### `/api/workflows/steps/[id]/complete/route.ts`
**Change**: Replaced `advanceInstanceReadySteps()` with `determineNextSteps()`

Before:
```typescript
await advanceInstanceReadySteps(tx, runtimeStep.instanceId);
```

After:
```typescript
await determineNextSteps({
  tx,
  instance: runtimeStep.instance,
  completedStep: runtimeStep,
});
```

#### `/api/workflows/steps/[id]/skip/route.ts`
**Change**: Same replacement as complete endpoint

#### `/api/workflows/instances/[id]/advance/route.ts`
**Change**: Updated manual advance endpoint to use new logic
- Now fetches full instance (with contextData)
- Calls `determineNextSteps()` for conditional evaluation

### 3. Comprehensive Unit Tests (`tests/unit/workflows/determine-next-steps.spec.ts`)
**Lines**: 458  
**Test Count**: 12 tests across 6 test suites  
**Status**: ✅ All passing

**Test Coverage**:

1. **Linear Workflows (ALWAYS condition)** (3 tests)
   - Activate first PENDING step with no condition
   - Don't activate if prior steps not completed
   - Return 0 if no PENDING steps exist

2. **Conditional Workflows (IF_TRUE)** (2 tests)
   - Activate when condition evaluates to true
   - Skip when condition evaluates to false

3. **Conditional Workflows (IF_FALSE)** (2 tests)
   - Activate when condition evaluates to false
   - Skip when condition evaluates to true

4. **Compound Conditions** (2 tests)
   - Handle AND logic correctly
   - Handle OR logic correctly

5. **Error Handling** (2 tests)
   - Continue evaluation if condition evaluation fails
   - Warn if conditionType exists but conditionConfig missing

6. **Multiple Steps** (1 test)
   - Handle branching workflow with multiple conditional steps

**Test Results**:
```
✓ tests/unit/workflows/determine-next-steps.spec.ts (12)
Test Files  1 passed (1)
Tests  12 passed (12)
Duration  585ms
```

## Implementation Highlights

### Automatic Step Skipping
When a condition isn't met, steps are automatically skipped with a descriptive note:
```typescript
await tx.workflowInstanceStep.update({
  where: { id: step.id },
  data: {
    actionState: ActionState.SKIPPED,
    notes: `Skipped: Condition not met (${conditionType}, evaluated to ${result.value})`,
    updatedAt: now,
  },
});
```

### Branching Support
The function continues evaluating subsequent steps after skipping, enabling true branching:
```typescript
if (shouldActivate) {
  // Activate and notify
  await tx.workflowInstanceStep.update({ ... });
  await notifyStepReady(tx, step.id);
} else {
  // Skip and CONTINUE to next step
  await tx.workflowInstanceStep.update({ ... });
  continue; // Key: Don't break, keep evaluating
}
```

### Context-Aware Evaluation
Uses workflow context data for condition evaluation:
```typescript
const evalContext: WorkflowRuntimeContext = {
  tx,
  instance,
  step: completedStep ?? stepModels[0],
  context: isJsonObject(instance.contextData ?? null)
    ? (instance.contextData as Record<string, unknown>)
    : {},
  // ...
};

const result = ConditionEvaluator.evaluate(
  step.conditionConfig as unknown as ConditionConfig,
  evalContext,
);
```

### Observability & Metrics
Tracks all state transitions and records metrics:
```typescript
WorkflowMetrics.recordStepAdvanced(step.actionType);
WorkflowMetrics.recordTransition(step.actionType, ActionState.PENDING, ActionState.READY);
WorkflowMetrics.recordTransition(step.actionType, ActionState.PENDING, ActionState.SKIPPED);
```

## Integration Points

### Replaced Function
**Old**: `advanceInstanceReadySteps()` in `lib/workflows/service.ts`
- Simple linear activation (first PENDING → READY)
- No condition support
- Single step at a time

**New**: `determineNextSteps()` in `lib/workflows/runtime.ts`
- Conditional branching support
- IF_TRUE/IF_FALSE logic
- Auto-skipping of unmet conditions
- Multi-step evaluation
- Context-aware decisions

### Updated Endpoints (3)
1. `POST /api/workflows/steps/[id]/complete` - Step completion
2. `POST /api/workflows/steps/[id]/skip` - Admin skip
3. `POST /api/workflows/instances/[id]/advance` - Manual advance

All now use `determineNextSteps()` for intelligent next-step activation.

## Usage Examples

### Example 1: Approval-Based Branching
```typescript
// Workflow context after approval step completes:
{ approved: true, reviewerComments: "LGTM" }

// Step 2 Configuration:
{
  order: 2,
  title: "Send Approval Notification",
  conditionType: "IF_TRUE",
  conditionConfig: {
    type: "simple",
    field: "workflow.context.approved",
    operator: "==",
    value: true,
  }
}

// Result: Step 2 is ACTIVATED (notification sent)

// Step 3 Configuration:
{
  order: 3,
  title: "Request Corrections",
  conditionType: "IF_FALSE",
  conditionConfig: {
    type: "simple",
    field: "workflow.context.approved",
    operator: "==",
    value: true,
  }
}

// Result: Step 3 is SKIPPED (corrections not needed)
```

### Example 2: Amount-Based Decision
```typescript
// Workflow context:
{ amount: 15000, clientType: "corporate" }

// Step Configuration:
{
  order: 4,
  title: "Senior Lawyer Approval",
  conditionType: "IF_TRUE",
  conditionConfig: {
    type: "compound",
    logic: "OR",
    conditions: [
      {
        type: "simple",
        field: "workflow.context.amount",
        operator: ">",
        value: 10000,
      },
      {
        type: "simple",
        field: "workflow.context.clientType",
        operator: "==",
        value: "government",
      }
    ]
  }
}

// Result: ACTIVATED (amount > 10000 is true)
```

## Type Workarounds

Due to Prisma client not yet regenerating with new fields, temporary type extensions were added:

```typescript
// TODO: Remove once Prisma generates ConditionType enum
type ConditionType = "ALWAYS" | "IF_TRUE" | "IF_FALSE" | "SWITCH";

// Extended type with conditional fields
type WorkflowInstanceStepWithConditions = WorkflowInstanceStepWithTemplate & {
  conditionType?: ConditionType | null;
  conditionConfig?: Prisma.JsonValue | null;
  nextStepOnTrue?: number | null;
  nextStepOnFalse?: number | null;
};
```

These will be removed once Prisma is fully regenerated.

## Code Quality

### Linting
- ✅ 0 new ESLint errors (2 pre-existing errors in file, unrelated)
- ✅ All TypeScript types properly handled with workarounds
- ✅ Proper error handling and logging

### Testing
- ✅ 12/12 tests passing
- ✅ Linear workflows tested
- ✅ Conditional branching tested (IF_TRUE, IF_FALSE)
- ✅ Compound conditions tested (AND, OR)
- ✅ Error handling tested
- ✅ Multi-step branching tested

### Documentation
- ✅ JSDoc comments on main function
- ✅ Inline comments explaining algorithm
- ✅ Clear variable names and structure

## Backward Compatibility

✅ **Fully backward compatible**

Existing workflows without conditions:
- Still work exactly as before
- Steps with no `conditionType` default to "ALWAYS"
- Linear execution maintained for unconditional workflows

## Performance Considerations

**Single Query Optimization**:
- Fetches all steps once per call (not per-step queries)
- Evaluates conditions in-memory
- Batch updates to database

**Observability**:
- Tracing spans for monitoring
- Metrics recorded for analytics
- Errors logged for debugging

## Known Limitations

1. **SWITCH condition type** - Not yet implemented (future enhancement)
2. **nextStepOnTrue/False fields** - Added to schema but not yet used (reserved for explicit step routing in future)
3. **Parallel step execution** - Still sequential (P1.1 feature)

## Next Steps

**Phase 4: API & Validation** (Ready to start)
- Add Zod schemas for condition validation
- Update step creation/update endpoints
- Add condition validation endpoint
- Ensure frontend can safely configure conditions

**Estimated Effort**: 0.5-1 day

## Files Created/Modified

### Modified
- `lib/workflows/runtime.ts` (+180 lines - determineNextSteps function)
- `app/api/workflows/steps/[id]/complete/route.ts` (updated to use determineNextSteps)
- `app/api/workflows/steps/[id]/skip/route.ts` (updated to use determineNextSteps)
- `app/api/workflows/instances/[id]/advance/route.ts` (updated to use determineNextSteps)

### Created
- `tests/unit/workflows/determine-next-steps.spec.ts` (458 lines, 12 tests)
- `docs/features/workflow/P0.1-PHASE3-COMPLETION.md` (this file)

## Metrics

- **New Code**: ~180 lines (runtime logic)
- **Modified Endpoints**: 3
- **Unit Tests**: 12 tests (458 lines)
- **Test Pass Rate**: 100%
- **Test Duration**: 585ms
- **Linting Errors**: 0 (new code)
- **Breaking Changes**: 0

## Demo Scenarios Enabled

With Phase 3 complete, the following workflows can now execute:

1. **Conditional Approval Workflow**
   - Step 1: Submit for approval
   - Step 2: If approved → Send success email
   - Step 3: If rejected → Request revisions
   - Step 4: Final review (always)

2. **Amount-Based Review Workflow**
   - Step 1: Calculate amount
   - Step 2: If amount > $10K → Senior lawyer review
   - Step 3: If amount > $50K → Partner approval
   - Step 4: Process payment (always)

3. **Client Type Workflow**
   - Step 1: Identify client type
   - Step 2: If corporate → Corporate contract
   - Step 3: If individual → Standard contract
   - Step 4: If government → Enhanced compliance
   - Step 5: Finalize (always)

## Sign-Off

**Status**: ✅ **COMPLETED**  
**Quality**: Production-ready  
**Ready for Phase 4**: Yes  
**Breaking Changes**: No  
**Backward Compatible**: Yes

---

**Implementation Notes**:
1. determineNextSteps() fully functional with IF_TRUE/IF_FALSE logic
2. All API endpoints updated to use new function
3. Comprehensive test coverage (12 tests, all passing)
4. Automatic step skipping with descriptive notes
5. Branching workflows now supported
6. Observability and metrics integrated
7. Type workarounds documented for future cleanup
